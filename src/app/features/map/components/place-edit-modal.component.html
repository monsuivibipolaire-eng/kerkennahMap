<div
  class="fixed inset-0 z-40 flex items-start justify-center bg-black/50 overflow-y-auto"
>
  <div
    class="bg-white rounded-xl shadow-xl max-w-3xl w-full mx-4 my-8 p-6 space-y-4"
    *ngIf="place"
  >
    <h2 class="text-lg font-semibold text-gray-900 mb-2">
      Modifier le lieu
    </h2>

    <!-- Contenu principal : soit formulaire + carte, soit message de succès -->
    <ng-container *ngIf="!saveSuccess; else savedState">
      <!-- FORMULAIRE -->
      <form class="space-y-4" (ngSubmit)="onSubmit()">
        <!-- Nom -->
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">Nom</label>
          <input
            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
            [(ngModel)]="place!.name"
            name="name"
            required
          />
        </div>

        <!-- Description -->
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">
            Description
          </label>
          <textarea
            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
            rows="3"
            [(ngModel)]="place!.description"
            name="description"
            required
          ></textarea>
        </div>

        <!-- Catégories -->
        <div class="space-y-1">
          <label class="block text-sm font-medium text-gray-700">
            Catégories
          </label>
          <select
            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
            multiple
            [(ngModel)]="place!.categories"
            name="categories"
          >
            <option *ngFor="let c of categories" [ngValue]="c">
              {{ c }}
            </option>
          </select>
          <p class="text-xs text-gray-500 mt-1">
            Maintiens Ctrl (ou Cmd sur Mac) pour sélectionner plusieurs
            catégories.
          </p>
        </div>

        <!-- Images -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            Images
          </label>

          <div
            *ngIf="place!.images?.length; else noImages"
            class="grid grid-cols-2 gap-2"
          >
            <div
              *ngFor="let img of place!.images"
              class="relative border rounded-md overflow-hidden"
            >
              <img
                [src]="img"
                alt="Image du lieu"
                class="w-full h-24 object-cover"
              />
              <button
                type="button"
                (click)="removeImage(img)"
                class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded"
              >
                Supprimer
              </button>
            </div>
          </div>
          <ng-template #noImages>
            <p class="text-xs text-gray-500">
              Aucune image pour le moment.
            </p>
          </ng-template>

          <div class="flex items-center gap-2 text-xs text-gray-600">
            <input
              type="file"
              accept="image/*"
              multiple
              (change)="onImagesSelected($event)"
            />
            <span *ngIf="uploadingImages">Upload des images...</span>
          </div>
        </div>

        <!-- Vidéos -->
        <div class="space-y-2">
          <label class="block text-sm font-medium text-gray-700">
            Vidéos
          </label>

          <div *ngIf="place!.videos?.length; else noVideos" class="space-y-1">
            <div
              *ngFor="let vid of place!.videos"
              class="flex items-center justify-between border rounded-md px-3 py-1 text-xs"
            >
              <a
                [href]="vid"
                target="_blank"
                rel="noopener"
                class="text-blue-600 truncate mr-2"
              >
                {{ vid }}
              </a>
              <button
                type="button"
                (click)="removeVideo(vid)"
                class="bg-red-600 text-white text-xs px-2 py-0.5 rounded"
              >
                Supprimer
              </button>
            </div>
          </div>
          <ng-template #noVideos>
            <p class="text-xs text-gray-500">
              Aucune vidéo pour le moment.
            </p>
          </ng-template>

          <div class="flex items-center gap-2 text-xs text-gray-600">
            <input
              type="file"
              accept="video/*"
              multiple
              (change)="onVideosSelected($event)"
            />
            <span *ngIf="uploadingVideos">Upload des vidéos...</span>
          </div>
        </div>

        <!-- Erreur upload -->
        <div *ngIf="uploadError" class="text-xs text-red-600">
          {{ uploadError }}
        </div>

        <!-- BOUTONS -->
        <div class="flex justify-end gap-2 pt-2">
          <button
            type="button"
            class="px-4 py-1.5 rounded-md border border-gray-300 text-sm text-gray-700 hover:bg-gray-50"
            (click)="onCancel()"
            [disabled]="isSaving"
          >
            Annuler
          </button>

          <button
            type="submit"
            class="px-4 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 disabled:opacity-60"
            [disabled]="isSaving"
          >
            <ng-container *ngIf="!isSaving; else savingTpl">
              Enregistrer
            </ng-container>
            <ng-template #savingTpl>Enregistrement...</ng-template>
          </button>
        </div>
      </form>

      <!-- CARTE SOUS LE FORMULAIRE -->
      <div class="pt-4 space-y-2">
        <h3 class="text-sm font-medium text-gray-700">
          Emplacement sur la carte
        </h3>
        <p class="text-xs text-gray-500">
          Clique sur la carte pour déplacer le marqueur et mettre à jour les
          coordonnées du lieu.
        </p>
        <p class="text-xs text-gray-600" *ngIf="place">
          Lat :
          {{ place!.latitude | number: '1.4-4' }},
          Lng :
          {{ place!.longitude | number: '1.4-4' }}
        </p>

        <div
          class="h-64 w-full rounded overflow-hidden border border-gray-300 relative z-0"
        >
          <div
            class="h-full w-full"
            leaflet
            [leafletOptions]="mapOptions"
            [leafletLayers]="mapLayers"
            (leafletMapReady)="onMapReady($event)"
          ></div>
        </div>
      </div>
    </ng-container>

    <!-- ÉTAT ENREGISTRÉ -->
    <ng-template #savedState>
      <div class="py-10 flex flex-col items-center justify-center space-y-3">
        <div class="text-4xl">✅</div>
        <div class="text-base font-semibold text-gray-900">
          Modifications enregistrées
        </div>
        <p class="text-sm text-gray-600 text-center max-w-sm">
          Les informations du lieu ont été mises à jour avec succès.
        </p>
        <button
          type="button"
          class="mt-2 px-4 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700"
          (click)="onCancel()"
        >
          Fermer
        </button>
      </div>
    </ng-template>
  </div>
</div>
