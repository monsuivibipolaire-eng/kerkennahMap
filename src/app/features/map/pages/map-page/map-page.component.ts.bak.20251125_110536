import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LeafletModule } from '@bluehalo/ngx-leaflet';
import { Router, RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';
import * as L from 'leaflet';
import { PlacesService } from '../../../../core/services/places.service';
import { Place } from '../../../../core/models/place.model';
import { Subscription } from 'rxjs';

interface Village {
  name: string;
  latitude: number;
  longitude: number;
}

interface PlaceMarker {
  place: Place;
  marker: L.Marker;
  category: string;
}

interface VillageMarker {
  village: Village;
  marker: L.Marker;
}

@Component({
  selector: 'app-map-page',
  standalone: true,
  imports: [CommonModule, LeafletModule, RouterModule, FormsModule],
  templateUrl: './map-page.component.html',
  styleUrls: ['./map-page.component.css']
})
export class MapPageComponent implements OnInit, OnDestroy {

  // Options Leaflet : centrÃ© sur Kerkennah
  options: L.MapOptions = {
    center: L.latLng(34.72, 11.2),
    zoom: 11,
    minZoom: 10,
    maxZoom: 18,
    zoomControl: false,
    layers: [
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      })
    ]
  };

  // Couches affichÃ©es sur la carte
  layers: L.Layer[] = [];

  // DonnÃ©es provenant de Firestore
  places: Place[] = [];
  filteredPlaces: Place[] = []; // lieux visibles (dans la zone + filtre)

  private sub = new Subscription();
  private map?: L.Map;

  // Marqueurs
  private villageMarkers: VillageMarker[] = [];
  private placeMarkers: PlaceMarker[] = [];

  // ğŸ”¹ Villages principaux de Kerkennah (initial markers)
  private readonly kerkennahVillages: Village[] = [
    { name: "Mellita",      latitude: 34.6499253, longitude: 11.0344099 },
    { name: "Remla",        latitude: 34.706497,  longitude: 11.190000  },
    { name: "Kraten",       latitude: 34.820562,  longitude: 11.255213  },
    { name: "El Attaya",    latitude: 34.803000,  longitude: 11.250000  },
    { name: "Ennajet",      latitude: 34.770000,  longitude: 11.220000  },
    { name: "Ouled Kacem",  latitude: 34.760000,  longitude: 11.200000  },
    { name: "Kellabine",    latitude: 34.700000,  longitude: 11.150000  },
    { name: "El Abassia",   latitude: 34.700000,  longitude: 11.140000  },
    { name: "Ouled Yaneg",  latitude: 34.720000,  longitude: 11.210000  },
    { name: "Ouled Bou Ali",latitude: 34.740000,  longitude: 11.230000  },
    { name: "Sidi Fredj",   latitude: 34.742000,  longitude: 11.237000  },
    { name: "Sidi Youssef", latitude: 34.673000,  longitude: 11.000000  },
    { name: "Ech Chergui",  latitude: 34.730000,  longitude: 11.220000  }
  ];

  // Filtre catÃ©gorie
  selectedCategory = 'all';
  isFilterMenuOpen = false; // bouton flottant pour ouvrir/fermer le menu

  categoriesList = [
    { key: 'all',      label: 'Toutes les catÃ©gories',         icon: 'ğŸŒ' },
    { key: 'village',  label: 'Villages de Kerkennah',         icon: 'ğŸ˜ï¸' },
    { key: 'hotel',    label: 'HÃ©bergements',                  icon: 'ğŸ¨' },
    { key: 'restaurant', label: 'Restaurants & snacks',        icon: 'ğŸ½ï¸' },
    { key: 'cafe',     label: 'CafÃ©s & salons de thÃ©',         icon: 'â˜•' },
    { key: 'plage',    label: 'Plages & baignades',            icon: 'ğŸ–ï¸' },
    { key: 'port',     label: 'Ports & pÃªche',                 icon: 'âš“' },
    { key: 'sante',    label: 'SantÃ©',                         icon: 'ğŸ¥' },
    { key: 'culture',  label: 'Culture & religion',            icon: 'ğŸ•Œ' },
    { key: 'ecole',    label: 'Ã‰coles / Admin / Commerce',     icon: 'ğŸ¢' }
  ];

  constructor(
    private placesService: PlacesService,
    private router: Router
  ) {}

  ngOnInit(): void {
    // RÃ©cupÃ©rer les lieux approuvÃ©s depuis Firestore
    this.sub = this.placesService.getApprovedPlaces().subscribe(places => {
      this.places = places ?? [];
      this.buildPlaceMarkers();
      this.updateLayers();
    });
  }

  ngOnDestroy(): void {
    this.sub.unsubscribe();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Bouton flottant filtre â”€â”€â”€â”€â”€â”€â”€â”€â”€

  toggleFilterMenu(): void {
    this.isFilterMenuOpen = !this.isFilterMenuOpen;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ CatÃ©gories & icÃ´nes â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private mapCategory(categories: string[] = []): { key: string; emoji: string } {
    let type = 'default';
    let emoji = 'ğŸ“';

    const c = (categories || []).map(x => x.toLowerCase()).join(' ');

    if (c.includes('village')) {
      type = 'village';
      emoji = 'ğŸ˜ï¸';
    }
    // SantÃ© & urgences
    else if (c.includes('pharmacie') || c.includes('hÃ´pital') || c.includes('hopital')
      || c.includes('santÃ©') || c.includes('urgences')) {
      type = 'sante'; emoji = 'ğŸ¥';
    }
    // Ã‰cole / admin / commerce
    else if (c.includes('Ã©cole') || c.includes('ecole') || c.includes('lycÃ©e') || c.includes('lycee')
      || c.includes('college') || c.includes('collÃ¨ge')
      || c.includes('poste') || c.includes('mairie') || c.includes('ville')
      || c.includes('commerce') || c.includes('Ã©picerie') || c.includes('epicerie')
      || c.includes('magasin') || c.includes('marchÃ©') || c.includes('marche')) {
      type = 'ecole'; emoji = 'ğŸ¢';
    }
    // Restauration
    else if (c.includes('restaurant') || c.includes('snack') || c.includes('pizzeria') || c.includes('fast food')) {
      type = 'restaurant'; emoji = 'ğŸ½ï¸';
    }
    else if (c.includes('cafÃ©') || c.includes('cafe') || c.includes('salon de thÃ©') || c.includes('buvette')) {
      type = 'cafe'; emoji = 'â˜•';
    }
    // HÃ©bergement
    else if (c.includes('hÃ´tel') || c.includes('hotel') || c.includes('rÃ©sidence') || c.includes('residence')
      || c.includes("maison d'hÃ´tes") || c.includes("maison d hotes")) {
      type = 'hotel'; emoji = 'ğŸ¨';
    }
    // Plages / nature
    else if (c.includes('plage') || c.includes('baignade') || c.includes('mer')) {
      type = 'plage'; emoji = 'ğŸ–ï¸';
    }
    // Ports / pÃªche
    else if (c.includes('port') || c.includes('pÃªche') || c.includes('peche') || c.includes('bateau')) {
      type = 'port'; emoji = 'âš“';
    }
    // Culture / religion / patrimoine
    else if (c.includes('mosquÃ©e') || c.includes('mosquee') || c.includes('zaouia')
      || c.includes('histoire') || c.includes('musÃ©e') || c.includes('musee')
      || c.includes('ruine') || c.includes('site')) {
      type = 'culture'; emoji = 'ğŸ•Œ';
    }

    return { key: type, emoji };
  }

  private createIcon(categories: string[] = []): L.DivIcon {
    const { key, emoji } = this.mapCategory(categories);
    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div class="marker-pin ${key}"><span>${emoji}</span></div>`,
      iconSize: [42, 42],
      iconAnchor: [21, 42],
      popupAnchor: [0, -45]
    });
  }

  getCategoryEmoji(categories: string[] = []): string {
    return this.mapCategory(categories).emoji;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Construction des marqueurs â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private buildVillageMarkers(): void {
    if (this.villageMarkers.length > 0) return;

    this.villageMarkers = this.kerkennahVillages.map(v => {
      const marker = L.marker([v.latitude, v.longitude], {
        icon: this.createIcon(['village'])
      }).bindPopup(
        `<strong>${v.name}</strong><br/><small>Village de Kerkennah</small>`
      );

      return { village: v, marker };
    });
  }

  private buildPlaceMarkers(): void {
    if (!this.places || this.places.length === 0) return;

    this.placeMarkers = this.places.map(p => {
      const { key } = this.mapCategory(p.categories || []);

      const marker = L.marker([p.latitude, p.longitude], {
        icon: this.createIcon(p.categories || [])
      });

      marker.bindPopup(`
        <div class="popup-content">
          <strong>${p.name}</strong><br/>
          <small>${(p.categories || []).join(', ')}</small><br/>
          <button id="btn-${p.id}" class="popup-btn">Voir la fiche</button>
        </div>
      `);

      marker.on('popupopen', () => {
        const btn = document.getElementById(`btn-${p.id}`);
        if (btn) {
          btn.addEventListener('click', () => this.router.navigate(['/place', p.id]));
        }
      });

      return { place: p, marker, category: key };
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Zoom / bounds / filtre catÃ©gorie â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private updateLayers(): void {
    if (!this.map) return;

    const bounds = this.map.getBounds();
    const zoom = this.map.getZoom();

    // Villages : toujours affichÃ©s
    const villageLayers = this.villageMarkers.map(vm => vm.marker);

    // Lieux depuis Firestore : visibles seulement Ã  partir d'un certain zoom
    const MIN_ZOOM_FOR_PLACES = 12;

    const visiblePlaceMarkers =
      zoom >= MIN_ZOOM_FOR_PLACES
        ? this.placeMarkers.filter(pm => {
            if (this.selectedCategory === 'village') return false;
            if (this.selectedCategory !== 'all' && pm.category !== this.selectedCategory) {
              return false;
            }
            return bounds.contains(pm.marker.getLatLng());
          })
        : [];

    this.layers = [
      ...villageLayers,
      ...visiblePlaceMarkers.map(pm => pm.marker)
    ];

    this.filteredPlaces = visiblePlaceMarkers.map(pm => pm.place);
  }

  onCategoryChange(): void {
    this.updateLayers();
  }

  focusPlace(place: Place): void {
    if (!this.map) return;
    this.map.setView([place.latitude, place.longitude], Math.max(this.map.getZoom(), 14));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Leaflet : carte prÃªte â”€â”€â”€â”€â”€â”€â”€â”€â”€

  onMapReady(map: L.Map): void {
    this.map = map;

    this.buildVillageMarkers();
    this.buildPlaceMarkers();
    this.updateLayers();

    this.map.on('zoomend moveend', () => this.updateLayers());
  }
}
