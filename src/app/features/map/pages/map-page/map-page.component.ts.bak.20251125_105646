import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LeafletModule } from '@bluehalo/ngx-leaflet';
import { Router, RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';
import * as L from 'leaflet';
import { PlacesService } from '../../../../core/services/places.service';
import { Place } from '../../../../core/models/place.model';
import { Subscription } from 'rxjs';

interface Village {
  name: string;
  type: string;
  island: string;
  latitude: number;
  longitude: number;
}

interface PlaceMarker {
  place: Place;
  marker: L.Marker;
  category: string;
}

interface VillageMarker {
  name: string;
  marker: L.Marker;
  type: string;
  island: string;
}

@Component({
  selector: 'app-map-page',
  standalone: true,
  imports: [CommonModule, LeafletModule, RouterModule, FormsModule],
  templateUrl: './map-page.component.html',
  styleUrls: ['./map-page.component.css']
})
export class MapPageComponent implements OnInit, OnDestroy {

  // Options Leaflet : centrÃ© sur Kerkennah
  options: L.MapOptions = {
    center: L.latLng(34.7340, 11.2030),
    zoom: 11,
    minZoom: 10,
    maxZoom: 18,
    zoomControl: false,
    layers: [
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      })
    ]
  };

  // Couches affichÃ©es sur la carte
  layers: L.Layer[] = [];

  // DonnÃ©es
  places: Place[] = [];
  filteredPlaces: Place[] = []; // lieux visibles (dans la zone + filtre)

  private sub = new Subscription();
  private map?: L.Map;

  // Marqueurs
  private villageMarkers: VillageMarker[] = [];
  private placeMarkers: PlaceMarker[] = [];

  // ğŸ”¹ Villages de l'Ã®le de Kerkennah (d'aprÃ¨s ton JSON)
  private readonly kerkennahVillages: Village[] = [
    { name: 'Remla',           type: 'village',       island: 'Chergui', latitude: 34.7315, longitude: 11.2170 },
    { name: 'Mellita',         type: 'village',       island: 'Gharbi',  latitude: 34.7070, longitude: 11.1630 },
    { name: 'El Attaya',       type: 'village',       island: 'Chergui', latitude: 34.7430, longitude: 11.2940 },
    { name: 'Ennajet',         type: 'village',       island: 'Chergui', latitude: 34.7420, longitude: 11.2520 },
    { name: 'El Kraten',       type: 'village',       island: 'Chergui', latitude: 34.7445, longitude: 11.3220 },
    { name: 'El Abbassia',     type: 'village',       island: 'Chergui', latitude: 34.7205, longitude: 11.2425 },
    { name: 'Ouled Ezzeddine', type: 'village',       island: 'Chergui', latitude: 34.7350, longitude: 11.2320 },
    { name: 'Ouled Kacem',     type: 'village',       island: 'Chergui', latitude: 34.7260, longitude: 11.2640 },
    { name: 'Kellabine',       type: 'village',       island: 'Chergui', latitude: 34.7135, longitude: 11.2270 },
    { name: 'Ouled Yaneg',     type: 'village',       island: 'Chergui', latitude: 34.7055, longitude: 11.2550 },
    { name: 'Ouled Bou Ali',   type: 'village',       island: 'Chergui', latitude: 34.6995, longitude: 11.2350 },
    { name: 'Sidi Fredj',      type: 'village',       island: 'Chergui', latitude: 34.6950, longitude: 11.2220 },
    { name: 'Sidi Youssef',    type: 'village',       island: 'Gharbi',  latitude: 34.7000, longitude: 11.1200 },
    { name: 'Chergui',         type: 'imada_centre',  island: 'Chergui', latitude: 34.7340, longitude: 11.2030 }
  ];

  // Filtre catÃ©gorie
  selectedCategory = 'all';
  isFilterMenuOpen = false; // ğŸ”¹ bouton flottant pour ouvrir/fermer le menu

  categoriesList = [
    { key: 'all',      label: 'Toutes les catÃ©gories',         icon: 'ğŸŒ' },
    { key: 'village',  label: 'Villages de Kerkennah',         icon: 'ğŸ˜ï¸' },
    { key: 'hotel',    label: 'HÃ©bergements',                  icon: 'ğŸ¨' },
    { key: 'restaurant', label: 'Restaurants & snacks',        icon: 'ğŸ½ï¸' },
    { key: 'cafe',     label: 'CafÃ©s & salons de thÃ©',         icon: 'â˜•' },
    { key: 'plage',    label: 'Plages & baignades',            icon: 'ğŸ–ï¸' },
    { key: 'port',     label: 'Ports & pÃªche',                 icon: 'âš“' },
    { key: 'sante',    label: 'SantÃ©',                         icon: 'ğŸ¥' },
    { key: 'culture',  label: 'Culture & religion',            icon: 'ğŸ•Œ' },
    { key: 'ecole',    label: 'Ã‰coles / Admin / Commerce',     icon: 'ğŸ¢' }
  ];

  constructor(
    private placesService: PlacesService,
    private router: Router
  ) {}

  // Au chargement : on rÃ©cupÃ¨re les lieux approuvÃ©s
  ngOnInit(): void {
    this.sub = this.placesService.getApprovedPlaces().subscribe(places => {
      this.places = places ?? [];
      this.buildPlaceMarkers();
      this.updateLayers();
    });
  }

  ngOnDestroy(): void {
    this.sub.unsubscribe();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  BOUTON FLOTTANT : Ouvrir / fermer menu filtres
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  toggleFilterMenu(): void {
    this.isFilterMenuOpen = !this.isFilterMenuOpen;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  CATÃ‰GORISATION & ICONES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private mapCategory(categories: string[] = []): { key: string; emoji: string } {
    let type = 'default';
    let emoji = 'ğŸ“';

    const c = (categories || []).map(x => x.toLowerCase()).join(' ');

    if (c.includes('village')) {
      type = 'village';
      emoji = 'ğŸ˜ï¸';
    }
    // SantÃ© & urgences
    else if (c.includes('pharmacie') || c.includes('hÃ´pital') || c.includes('hopital')
      || c.includes('santÃ©') || c.includes('urgences')) {
      type = 'sante'; emoji = 'ğŸ¥';
    }
    // Ã‰cole / admin / commerce
    else if (c.includes('Ã©cole') || c.includes('ecole') || c.includes('lycÃ©e') || c.includes('lycee')
      || c.includes('college') || c.includes('collÃ¨ge')
      || c.includes('poste') || c.includes('mairie') || c.includes('ville')
      || c.includes('commerce') || c.includes('Ã©picerie') || c.includes('epicerie')
      || c.includes('magasin') || c.includes('marchÃ©') || c.includes('marche')) {
      type = 'ecole'; emoji = 'ğŸ¢';
    }
    // Restauration
    else if (c.includes('restaurant') || c.includes('snack') || c.includes('pizzeria') || c.includes('fast food')) {
      type = 'restaurant'; emoji = 'ğŸ½ï¸';
    }
    else if (c.includes('cafÃ©') || c.includes('cafe') || c.includes('salon de thÃ©') || c.includes('buvette')) {
      type = 'cafe'; emoji = 'â˜•';
    }
    // HÃ©bergement
    else if (c.includes('hÃ´tel') || c.includes('hotel') || c.includes('rÃ©sidence') || c.includes('residence')
      || c.includes("maison d'hÃ´tes") || c.includes("maison d hotes")) {
      type = 'hotel'; emoji = 'ğŸ¨';
    }
    // Plages / nature
    else if (c.includes('plage') || c.includes('baignade') || c.includes('mer')) {
      type = 'plage'; emoji = 'ğŸ–ï¸';
    }
    // Ports / pÃªche
    else if (c.includes('port') || c.includes('pÃªche') || c.includes('peche') || c.includes('bateau')) {
      type = 'port'; emoji = 'âš“';
    }
    // Culture / religion / patrimoine
    else if (c.includes('mosquÃ©e') || c.includes('mosquee') || c.includes('zaouia')
      || c.includes('histoire') || c.includes('musÃ©e') || c.includes('musee')
      || c.includes('ruine') || c.includes('site')) {
      type = 'culture'; emoji = 'ğŸ•Œ';
    }

    return { key: type, emoji };
  }

  private createIcon(categories: string[] = []): L.DivIcon {
    const { key, emoji } = this.mapCategory(categories);
    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div class="marker-pin ${key}"><span>${emoji}</span></div>`,
      iconSize: [42, 42],
      iconAnchor: [21, 42],
      popupAnchor: [0, -45]
    });
  }

  getCategoryEmoji(categories: string[] = []): string {
    return this.mapCategory(categories).emoji;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  CONSTRUCTION DES MARQUEURS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private buildVillageMarkers(): void {
    if (this.villageMarkers.length > 0) return;

    this.villageMarkers = this.kerkennahVillages.map(v => {
      const marker = L.marker([v.latitude, v.longitude], {
        icon: this.createIcon(['village'])
      }).bindPopup(
        `<strong>${v.name}</strong><br/>
         <small>${v.type} - Ãle : ${v.island}</small>`
      );

      return { name: v.name, marker, type: v.type, island: v.island };
    });
  }

  private buildPlaceMarkers(): void {
    if (!this.places || this.places.length === 0) return;

    this.placeMarkers = this.places.map(p => {
      const { key } = this.mapCategory(p.categories || []);

      const marker = L.marker([p.latitude, p.longitude], {
        icon: this.createIcon(p.categories || [])
      });

      marker.bindPopup(`
        <div class="popup-content">
          <strong>${p.name}</strong><br/>
          <small>${(p.categories || []).join(', ')}</small><br/>
          <button id="btn-${p.id}" class="popup-btn">Voir la fiche</button>
        </div>
      `);

      marker.on('popupopen', () => {
        const btn = document.getElementById(`btn-${p.id}`);
        if (btn) {
          btn.addEventListener('click', () => this.router.navigate(['/place', p.id]));
        }
      });

      return { place: p, marker, category: key };
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  ZOOM / BOUNDS / FILTRE CATÃ‰GORIE
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private updateLayers(): void {
    if (!this.map) return;

    const bounds = this.map.getBounds();
    const zoom = this.map.getZoom();

    // âœ… Villages : toujours affichÃ©s (Leaflet gÃ¨re la visibilitÃ© dans la vue)
    const villageLayers = this.villageMarkers.map(vm => vm.marker);

    // âœ… Lieux visibles uniquement Ã  partir d'un certain zoom et dans la zone courante
    const MIN_ZOOM_FOR_PLACES = 12;

    const visiblePlaceMarkers =
      zoom >= MIN_ZOOM_FOR_PLACES
        ? this.placeMarkers.filter(pm => {
            // Si on filtre sur "village" â†’ masquer les lieux
            if (this.selectedCategory === 'village') return false;

            if (this.selectedCategory !== 'all' && pm.category !== this.selectedCategory) {
              return false;
            }

            return bounds.contains(pm.marker.getLatLng());
          })
        : [];

    this.layers = [
      ...villageLayers,
      ...visiblePlaceMarkers.map(pm => pm.marker)
    ];

    // Liste des lieux visibles pour la sidebar (Ã  gauche)
    this.filteredPlaces = visiblePlaceMarkers.map(pm => pm.place);
  }

  onCategoryChange(): void {
    this.updateLayers();
  }

  // Clique sur un Ã©lÃ©ment de la liste (sidebar)
  focusPlace(place: Place): void {
    if (!this.map) return;
    this.map.setView([place.latitude, place.longitude], Math.max(this.map.getZoom(), 14));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //  LEAFLET : carte prÃªte
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  onMapReady(map: L.Map): void {
    this.map = map;

    this.buildVillageMarkers();
    this.buildPlaceMarkers();
    this.updateLayers();

    // A chaque zoom / dÃ©placement â†’ recalcul des markers visibles
    this.map.on('zoomend moveend', () => this.updateLayers());
  }
}
