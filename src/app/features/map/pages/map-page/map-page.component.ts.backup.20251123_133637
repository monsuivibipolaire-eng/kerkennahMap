import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LeafletModule } from '@bluehalo/ngx-leaflet';
import { Router, RouterModule } from '@angular/router';
import * as L from 'leaflet';
import { Subscription } from 'rxjs';

import { PlacesService } from '../../../../core/services/places.service';
import { Place } from '../../../../core/models/place.model';
import { AuthService } from '../../../../core/services/auth.service';
import { User } from '../../../../core/models/user.model';

@Component({
  selector: 'app-map-page',
  standalone: true,
  imports: [CommonModule, LeafletModule, RouterModule],
  templateUrl: './map-page.component.html',
  styleUrls: ['./map-page.component.css']
})
export class MapPageComponent implements OnInit, OnDestroy {
  options: L.MapOptions = {
    layers: [L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 })],
    zoom: 11,
    center: L.latLng(34.71, 11.15)
  };

  places: Place[] = [];
  layers: L.Layer[] = [];

  private subPlaces: Subscription = new Subscription();
  private subUser: Subscription = new Subscription();
  private map: L.Map | null = null;
  private isAdmin = false;

  constructor(
    private placesService: PlacesService,
    private router: Router,
    private authService: AuthService
  ) {
    const iconRetinaUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png';
    const iconUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png';
    const shadowUrl = 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png';

    L.Marker.prototype.options.icon = L.icon({
      iconRetinaUrl,
      iconUrl,
      shadowUrl,
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      tooltipAnchor: [16, -28],
      shadowSize: [41, 41]
    });
  }

  ngOnInit(): void {
    this.subUser = this.authService.user$.subscribe((user: User | null | undefined) => {
      this.isAdmin = !!user && Array.isArray(user.roles) && user.roles.includes('admin');
    });

    this.subPlaces = this.placesService.getApprovedPlaces().subscribe(data => {
      this.places = data || [];
      this.updateMarkers();
    });
  }

  ngOnDestroy(): void {
    this.subPlaces.unsubscribe();
    this.subUser.unsubscribe();
  }

  onMapReady(map: L.Map): void {
    this.map = map;
    this.updateMarkers();
  }

  private updateMarkers(): void {
    if (!this.map) {
      return;
    }

    this.layers = this.places.map(p => {
      const marker = L.marker([p.latitude, p.longitude], {
        icon: this.getIcon(p.categories || [])
      });

      const img = (p.images && p.images.length > 0)
        ? p.images[0]
        : 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/300px-No_image_available.svg.png';

      const adminButtonHtml = this.isAdmin ? `
        <button id="edit-${p.id}"
                class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-full text-xs shadow-sm w-full">
          âœï¸ Modifier
        </button>` : '';

      marker.bindPopup(`
        <div class="text-center font-sans">
          <h3 class="font-bold text-base text-gray-800 mb-2 truncate">${p.name}</h3>
          <div class="relative">
            <img src="${img}" class="popup-image" onerror="this.src='https://via.placeholder.com/300?text=Image+Indisponible'">
            <span class="absolute bottom-3 right-1 bg-white/80 px-1 rounded text-[10px] font-bold text-gray-600">
              ${(p.categories && p.categories[0]) || 'Lieu'}
            </span>
          </div>
          <button id="btn-${p.id}"
                  class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm transition shadow-sm flex items-center justify-center gap-1 w-full">
            <span>ğŸ‘ï¸</span> Voir DÃ©tails
          </button>
          ${adminButtonHtml}
        </div>
      `);

      marker.on('popupopen', () => {
        const btn = document.getElementById(`btn-${p.id}`);
        if (btn) {
          btn.addEventListener('click', () => this.router.navigate(['/place', p.id]));
        }

        const editBtn = document.getElementById(`edit-${p.id}`);
        if (editBtn && this.isAdmin) {
          editBtn.addEventListener('click', () =>
            this.router.navigate(['/place', p.id], { queryParams: { edit: '1' } })
          );
        }
      });

      return marker;
    });
  }

  private getIcon(categories: string[]): L.DivIcon {
    let type = 'default';
    let emoji = 'ğŸ“';

    const c = categories.map(x => x.toLowerCase()).join(' ');

    if (c.includes('pharmacie') || c.includes('hÃ´pital') || c.includes('santÃ©') || c.includes('urgences')) {
      type = 'sante'; emoji = 'ğŸ¥';
    } else if (c.includes('Ã©cole') || c.includes('lycÃ©e') || c.includes('collÃ¨ge') || c.includes('poste') || c.includes('mairie') || c.includes('ville')) {
      type = 'ecole'; emoji = 'ğŸ“';
      if (c.includes('poste') || c.includes('mairie')) emoji = 'ğŸ¢';
    } else if (c.includes('restaurant') || c.includes('snack') || c.includes('pizzeria') || c.includes('fast food')) {
      type = 'restaurant'; emoji = 'ğŸ´';
    } else if (c.includes('cafÃ©') || c.includes('salon de thÃ©') || c.includes('buvette')) {
      type = 'cafe'; emoji = 'â˜•';
    } else if (c.includes('hÃ´tel') || c.includes('hotel') || c.includes('rÃ©sidence') || c.includes('maison d\'hÃ´tes')) {
      type = 'hotel'; emoji = 'ğŸ¨';
    } else if (c.includes('plage') || c.includes('baignade') || c.includes('mer')) {
      type = 'plage'; emoji = 'ğŸ–ï¸';
    } else if (c.includes('port') || c.includes('pÃªche') || c.includes('bateau')) {
      type = 'port'; emoji = 'âš“';
    } else if (c.includes('mosquÃ©e') || c.includes('zaouia')) {
      type = 'culture'; emoji = 'ğŸ•Œ';
    } else if (c.includes('histoire') || c.includes('musÃ©e') || c.includes('ruine') || c.includes('site')) {
      type = 'culture'; emoji = 'ğŸ›ï¸';
    }

    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div class="marker-pin ${type}"><span>${emoji}</span></div>`,
      iconSize: [42, 42],
      iconAnchor: [21, 42],
      popupAnchor: [0, -45]
    });
  }
}
