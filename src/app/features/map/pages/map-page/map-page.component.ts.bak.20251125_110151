import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LeafletModule } from '@bluehalo/ngx-leaflet';
import { Router, RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';
import * as L from 'leaflet';
import { PlacesService } from '../../../../core/services/places.service';
import { Place } from '../../../../core/models/place.model';
import { Subscription } from 'rxjs';

interface Village {
  name: string;
  alt?: string[];
  type: string;
  imada?: string;
  island: string;
  latitude: number;
  longitude: number;
}

interface PlaceMarker {
  place: Place;
  marker: L.Marker;
  category: string;
}

interface VillageMarker {
  village: Village;
  marker: L.Marker;
}

@Component({
  selector: 'app-map-page',
  standalone: true,
  imports: [CommonModule, LeafletModule, RouterModule, FormsModule],
  templateUrl: './map-page.component.html',
  styleUrls: ['./map-page.component.css']
})
export class MapPageComponent implements OnInit, OnDestroy {

  // Options Leaflet : centrÃ© sur Kerkennah (Chergui)
  options: L.MapOptions = {
    center: L.latLng(34.73400, 11.23000),
    zoom: 11,
    minZoom: 10,
    maxZoom: 18,
    zoomControl: false,
    layers: [
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      })
    ]
  };

  // Couches affichÃ©es sur la carte
  layers: L.Layer[] = [];

  // DonnÃ©es
  places: Place[] = [];
  filteredPlaces: Place[] = []; // lieux visibles (dans la zone + filtre)

  private sub = new Subscription();
  private map?: L.Map;

  // Marqueurs
  private villageMarkers: VillageMarker[] = [];
  private placeMarkers: PlaceMarker[] = [];

  // Villages + localitÃ©s + Ã®lots de Kerkennah (coordonnÃ©es prÃ©cises)
  private readonly kerkennahVillages: Village[] = [
    { name: "Remla", alt: ["Erramla","El Ramla"], type: "village", imada: "El Ramla", island: "Chergui", latitude: 34.71083, longitude: 11.19444 },
    { name: "Mellita", alt: ["Melita"], type: "village", imada: "Melita", island: "Gharbi", latitude: 34.65278, longitude: 11.03167 },
    { name: "El Attaya", alt: ["El Ataya","Al 'Ataya"], type: "village", imada: "El Ataya", island: "Chergui", latitude: 34.74447, longitude: 11.29631 },
    { name: "Ennajet", alt: ["Najet"], type: "village", imada: "Ennajet", island: "Chergui", latitude: 34.73500, longitude: 11.25700 },
    { name: "El Kraten", alt: ["Kraten"], type: "village", imada: "El Kraten", island: "Chergui", latitude: 34.74800, longitude: 11.32000 },
    { name: "El Abbassia", alt: ["Abbassia","Abessia"], type: "village", imada: "El Kallabine (secteur Abbassia)", island: "Chergui", latitude: 34.72700, longitude: 11.24700 },
    { name: "Kellabine", alt: ["El Kallabine","Kellebine"], type: "village", imada: "El Kallabine", island: "Chergui", latitude: 34.71500, longitude: 11.23000 },
    { name: "Ouled Ezzeddine", type: "village", imada: "El Ramla (secteur Ouled Ezzeddine)", island: "Chergui", latitude: 34.73900, longitude: 11.22500 },
    { name: "Ouled Kacem", alt: ["Ouled Kassem"], type: "village", imada: "Ouled Kacem", island: "Chergui", latitude: 34.72500, longitude: 11.26800 },
    { name: "Ouled Yaneg", alt: ["Ouled Yang"], type: "village", imada: "Echargui (secteur Ouled Yaneg)", island: "Chergui", latitude: 34.70500, longitude: 11.25500 },
    { name: "Ouled Bou Ali", type: "village", imada: "Mellita / Ouled Bou Ali", island: "Gharbi", latitude: 34.69000, longitude: 11.15000 },
    { name: "Sidi Fredj", alt: ["Sidi Frej"], type: "village", imada: "Sidi Frej", island: "Chergui", latitude: 34.69500, longitude: 11.22000 },

    // LocalitÃ©s
    { name: "El Kantra", alt: ["La Kantra"], type: "locality", imada: "El Kantra", island: "Gharbi / Chergui (chaussÃ©e)", latitude: 34.70700, longitude: 11.16300 },
    { name: "Ech Chergui", alt: ["Chergui","El Chargui"], type: "locality", imada: "El Chargui", island: "Chergui", latitude: 34.72000, longitude: 11.23500 },
    { name: "Jouaber", type: "locality", imada: "El Ataya (secteur Jouaber)", island: "Chergui", latitude: 34.75200, longitude: 11.28500 },

    // Ãles principales
    { name: "Chergui (Ã®le principale)", alt: ["Ech Chergui","Grande Kerkennah","Kerkena","Cherguia"], type: "main_island", island: "Chergui", latitude: 34.73400, longitude: 11.23000 },
    { name: "Gharbi (Ã®le principale)", alt: ["Mellita","Gharbia"], type: "main_island", island: "Gharbi", latitude: 34.71203, longitude: 11.16348 },

    // Ãlots
    { name: "Gremdi", alt: ["Jazirat Gremdi"], type: "islet", island: "Chergui", latitude: 34.75528, longitude: 11.32111 },
    { name: "Roumadia", alt: ["Roummadiya","Roumadya"], type: "islet", island: "Chergui", latitude: 34.76000, longitude: 11.30000 },
    { name: "Rakadia", alt: ["Rakadiya"], type: "islet", island: "Chergui", latitude: 34.76000, longitude: 11.28000 },
    { name: "Sefnou", type: "islet", island: "Chergui", latitude: 34.76500, longitude: 11.26000 },
    { name: "Charmadia", alt: ["Charmandia"], type: "islet", island: "Chergui", latitude: 34.77000, longitude: 11.24000 },
    { name: "Ch'hima", alt: ["Chhima"], type: "islet", island: "Chergui", latitude: 34.74000, longitude: 11.33000 },
    { name: "Keblia", type: "islet", island: "Chergui", latitude: 34.74500, longitude: 11.34000 },
    { name: "Jeblia", type: "islet", island: "Chergui", latitude: 34.75000, longitude: 11.35000 },
    { name: "El Froukh", type: "islet", island: "Chergui", latitude: 34.75200, longitude: 11.36000 },
    { name: "Firkik", type: "islet", island: "Chergui", latitude: 34.75800, longitude: 11.37000 },
    { name: "Belgharsa", type: "islet", island: "Chergui", latitude: 34.76200, longitude: 11.38000 },
    { name: "El Haj Hmida", alt: ["Haj Hmida"], type: "islet", island: "Chergui", latitude: 34.76800, longitude: 11.39000 }
  ];

  // Filtre catÃ©gorie
  selectedCategory = 'all';
  isFilterMenuOpen = false; // bouton flottant pour ouvrir/fermer le menu

  categoriesList = [
    { key: 'all',      label: 'Toutes les catÃ©gories',         icon: 'ğŸŒ' },
    { key: 'village',  label: 'Villages de Kerkennah',         icon: 'ğŸ˜ï¸' },
    { key: 'hotel',    label: 'HÃ©bergements',                  icon: 'ğŸ¨' },
    { key: 'restaurant', label: 'Restaurants & snacks',        icon: 'ğŸ½ï¸' },
    { key: 'cafe',     label: 'CafÃ©s & salons de thÃ©',         icon: 'â˜•' },
    { key: 'plage',    label: 'Plages & baignades',            icon: 'ğŸ–ï¸' },
    { key: 'port',     label: 'Ports & pÃªche',                 icon: 'âš“' },
    { key: 'sante',    label: 'SantÃ©',                         icon: 'ğŸ¥' },
    { key: 'culture',  label: 'Culture & religion',            icon: 'ğŸ•Œ' },
    { key: 'ecole',    label: 'Ã‰coles / Admin / Commerce',     icon: 'ğŸ¢' }
  ];

  constructor(
    private placesService: PlacesService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.sub = this.placesService.getApprovedPlaces().subscribe(places => {
      this.places = places ?? [];
      this.buildPlaceMarkers();
      this.updateLayers();
    });
  }

  ngOnDestroy(): void {
    this.sub.unsubscribe();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Bouton flottant filtre â”€â”€â”€â”€â”€â”€â”€â”€â”€

  toggleFilterMenu(): void {
    this.isFilterMenuOpen = !this.isFilterMenuOpen;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ CatÃ©gories & icÃ´nes â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private mapCategory(categories: string[] = []): { key: string; emoji: string } {
    let type = 'default';
    let emoji = 'ğŸ“';

    const c = (categories || []).map(x => x.toLowerCase()).join(' ');

    if (c.includes('village')) {
      type = 'village';
      emoji = 'ğŸ˜ï¸';
    }
    // SantÃ© & urgences
    else if (c.includes('pharmacie') || c.includes('hÃ´pital') || c.includes('hopital')
      || c.includes('santÃ©') || c.includes('urgences')) {
      type = 'sante'; emoji = 'ğŸ¥';
    }
    // Ã‰cole / admin / commerce
    else if (c.includes('Ã©cole') || c.includes('ecole') || c.includes('lycÃ©e') || c.includes('lycee')
      || c.includes('college') || c.includes('collÃ¨ge')
      || c.includes('poste') || c.includes('mairie') || c.includes('ville')
      || c.includes('commerce') || c.includes('Ã©picerie') || c.includes('epicerie')
      || c.includes('magasin') || c.includes('marchÃ©') || c.includes('marche')) {
      type = 'ecole'; emoji = 'ğŸ¢';
    }
    // Restauration
    else if (c.includes('restaurant') || c.includes('snack') || c.includes('pizzeria') || c.includes('fast food')) {
      type = 'restaurant'; emoji = 'ğŸ½ï¸';
    }
    else if (c.includes('cafÃ©') || c.includes('cafe') || c.includes('salon de thÃ©') || c.includes('buvette')) {
      type = 'cafe'; emoji = 'â˜•';
    }
    // HÃ©bergement
    else if (c.includes('hÃ´tel') || c.includes('hotel') || c.includes('rÃ©sidence') || c.includes('residence')
      || c.includes("maison d'hÃ´tes") || c.includes("maison d hotes")) {
      type = 'hotel'; emoji = 'ğŸ¨';
    }
    // Plages / nature
    else if (c.includes('plage') || c.includes('baignade') || c.includes('mer')) {
      type = 'plage'; emoji = 'ğŸ–ï¸';
    }
    // Ports / pÃªche
    else if (c.includes('port') || c.includes('pÃªche') || c.includes('peche') || c.includes('bateau')) {
      type = 'port'; emoji = 'âš“';
    }
    // Culture / religion / patrimoine
    else if (c.includes('mosquÃ©e') || c.includes('mosquee') || c.includes('zaouia')
      || c.includes('histoire') || c.includes('musÃ©e') || c.includes('musee')
      || c.includes('ruine') || c.includes('site')) {
      type = 'culture'; emoji = 'ğŸ•Œ';
    }

    return { key: type, emoji };
  }

  private createIcon(categories: string[] = []): L.DivIcon {
    const { key, emoji } = this.mapCategory(categories);
    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div class="marker-pin ${key}"><span>${emoji}</span></div>`,
      iconSize: [42, 42],
      iconAnchor: [21, 42],
      popupAnchor: [0, -45]
    });
  }

  getCategoryEmoji(categories: string[] = []): string {
    return this.mapCategory(categories).emoji;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Construction des marqueurs â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private buildVillageMarkers(): void {
    if (this.villageMarkers.length > 0) return;

    this.villageMarkers = this.kerkennahVillages.map(v => {
      const marker = L.marker([v.latitude, v.longitude], {
        icon: this.createIcon(['village'])
      }).bindPopup(
        `<strong>${v.name}</strong><br/>
         <small>${v.type} â€“ ${v.island}</small><br/>
         ${v.imada ? `<small>Imada : ${v.imada}</small>` : ''}`
      );

      return { village: v, marker };
    });
  }

  private buildPlaceMarkers(): void {
    if (!this.places || this.places.length === 0) return;

    this.placeMarkers = this.places.map(p => {
      const { key } = this.mapCategory(p.categories || []);

      const marker = L.marker([p.latitude, p.longitude], {
        icon: this.createIcon(p.categories || [])
      });

      marker.bindPopup(`
        <div class="popup-content">
          <strong>${p.name}</strong><br/>
          <small>${(p.categories || []).join(', ')}</small><br/>
          <button id="btn-${p.id}" class="popup-btn">Voir la fiche</button>
        </div>
      `);

      marker.on('popupopen', () => {
        const btn = document.getElementById(`btn-${p.id}`);
        if (btn) {
          btn.addEventListener('click', () => this.router.navigate(['/place', p.id]));
        }
      });

      return { place: p, marker, category: key };
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Zoom / bounds / filtre catÃ©gorie â”€â”€â”€â”€â”€â”€â”€â”€â”€

  private updateLayers(): void {
    if (!this.map) return;

    const bounds = this.map.getBounds();
    const zoom = this.map.getZoom();

    // Villages / Ã®lots : toujours affichÃ©s (Leaflet gÃ¨re la vue)
    const villageLayers = this.villageMarkers.map(vm => vm.marker);

    // Lieux visibles uniquement Ã  partir d'un certain zoom et dans la zone courante
    const MIN_ZOOM_FOR_PLACES = 12;

    const visiblePlaceMarkers =
      zoom >= MIN_ZOOM_FOR_PLACES
        ? this.placeMarkers.filter(pm => {
            if (this.selectedCategory === 'village') return false;
            if (this.selectedCategory !== 'all' && pm.category !== this.selectedCategory) {
              return false;
            }
            return bounds.contains(pm.marker.getLatLng());
          })
        : [];

    this.layers = [
      ...villageLayers,
      ...visiblePlaceMarkers.map(pm => pm.marker)
    ];

    this.filteredPlaces = visiblePlaceMarkers.map(pm => pm.place);
  }

  onCategoryChange(): void {
    this.updateLayers();
  }

  focusPlace(place: Place): void {
    if (!this.map) return;
    this.map.setView([place.latitude, place.longitude], Math.max(this.map.getZoom(), 14));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€ Leaflet : carte prÃªte â”€â”€â”€â”€â”€â”€â”€â”€â”€

  onMapReady(map: L.Map): void {
    this.map = map;

    this.buildVillageMarkers();
    this.buildPlaceMarkers();
    this.updateLayers();

    this.map.on('zoomend moveend', () => this.updateLayers());
  }
}
